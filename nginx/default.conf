server {
  listen 80 default_server;
  server_name _;

  root /var/www/html/public;
  index index.php index.html;
  charset utf-8;

  # ----- лимиты (nginx глобальный файл 00-global.conf тоже ок) -----
  client_max_body_size 50m;

  # ---- только страница для 413 (она должна вернуть CORS, иначе fetch проглотит): ----
  error_page 413 = /__cors_413.json;
  location = /__cors_413.json {
      # Никаких Origin тут вычислять не надо — это чисто служебный ответ
      add_header Access-Control-Allow-Origin "*" always;
      add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-Admin-Token" always;
      add_header Content-Type application/json;
      return 413 '{"error":"Request Entity Too Large"}';
  }

  # ---------- API ----------
  location ~* ^/api/ {
      client_max_body_size 50m;

      # Только preflight обрабатываем на уровне nginx,
      # все остальные CORS-заголовки отдаст Laravel (config/cors.php)
      if ($request_method = OPTIONS) {
          add_header Access-Control-Allow-Origin "*" always;
          add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
          add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-Admin-Token" always;
          add_header Access-Control-Max-Age 86400 always;
          add_header Content-Length 0;
          add_header Content-Type text/plain;
          return 204;
      }

      try_files $uri $uri/ /index.php?$query_string;
  }

  # ---------- WEB ----------
  location / {
    client_max_body_size 50m;
    try_files $uri $uri/ /index.php?$query_string;
  }

  location ~ \.php$ {
    client_max_body_size 50m;

    include        fastcgi_params;
    fastcgi_pass   php:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
  }

  # статика (+ /storage)
  location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff2?|ttf|otf)$ {
    expires 7d;
    access_log off;
    try_files $uri =404;
  }
}
